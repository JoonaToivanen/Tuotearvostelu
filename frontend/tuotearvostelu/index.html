<!doctype html>
<html lang="fi">
  <head>
    <meta charset="UTF-8" />
    <title>Tuotteet ja arvostelut</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 2rem;
      }

      #app {
        max-width: 1200px;
        margin: auto;
        background: white;
        padding: 2rem;
        border-radius: 14px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }

      button {
        background: #2563eb;
        color: white;
        border: none;
        padding: 0.5rem 1.1rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
      }

      button:hover {
        background: #1d4ed8;
      }

      .back-btn {
        background: none;
        color: #2563eb;
        padding: 0;
        margin-bottom: 1rem;
      }

      .back-btn:hover {
        text-decoration: underline;
      }

      input,
      textarea {
        width: 100%;
        padding: 0.6rem;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        margin: 0.4rem 0;
      }

      textarea {
        resize: vertical;
      }

      .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1.2rem;
      }

      .product {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        background: white;
        transition:
          transform 0.15s,
          box-shadow 0.15s;
      }

      .product:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      }

      .product h3 {
        margin: 0 0 0.4rem 0;
      }
      .product p {
        margin: 0;
        color: #4b5563;
      }

      .modal {
        margin: 1.5rem 0;
        padding: 1rem;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
      }

      .review {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 0.8rem;
        margin-top: 0.8rem;
      }

      .review strong {
        display: block;
        margin-bottom: 0.3rem;
      }

      .review button {
        margin-top: 0.3rem;
        margin-right: 0.3rem;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <h1>Tuotearvostelut</h1>

      <div v-if="!currentUser">
        <input v-model="username" placeholder="Nimimerkki" />
        <button @click="login">Kirjaudu</button>
      </div>

      <div v-else>
        <div class="top-bar">
          <div>
            Kirjautunut: <strong>{{ currentUser }}</strong>
            <button @click="logout">Ulos</button>
          </div>

          <button @click="showForm = !showForm">
            {{ showForm ? "Peruuta" : "Lisää tuote" }}
          </button>
        </div>

        <div v-if="!selectedProduct">
          <div v-if="showForm" class="modal">
            <input v-model="newProduct.name" placeholder="Tuotteen nimi" />
            <textarea
              v-model="newProduct.description"
              placeholder="Tuotteen kuvaus"
            ></textarea>
            <button @click="addProduct">Tallenna</button>
          </div>

          <div class="product-grid">
            <div
              v-for="product in products"
              :key="product._id"
              class="product"
              @click="openProduct(product)"
            >
              <h3>{{ product.tuoteNimi || product.name }}</h3>
              <p v-if="product.tuoteKuvaus || product.description">
                {{ (product.tuoteKuvaus || product.description).length > 80 ?
                (product.tuoteKuvaus || product.description).slice(0, 80) +
                '...' : (product.tuoteKuvaus || product.description) }}
              </p>
              <p v-else>Ei kuvausta.</p>
            </div>
          </div>
        </div>

        <div v-else>
          <button class="back-btn" @click="selectedProduct = null">
            ⬅ Takaisin
          </button>

          <h2>{{ selectedProduct.name }}</h2>
          <p>{{ selectedProduct.description }}</p>

          <h3>Arvostelut</h3>

          <div
            v-for="review in selectedProduct.reviews"
            :key="review._id"
            class="review"
          >
            <strong>{{ review.kirjoittaja }}</strong>

            <div v-if="!review.editing">{{ review.arvostelu }}</div>
            <textarea v-else v-model="review.arvostelu"></textarea>

            <div v-if="review.kirjoittaja === currentUser">
              <button v-if="!review.editing" @click="review.editing = true">
                Muokkaa
              </button>
              <button v-else @click="saveEditedReview(review)">Tallenna</button>
              <button @click="deleteReview(review)">Poista</button>
            </div>
          </div>

          <textarea
            v-model="newReview"
            placeholder="Kirjoita arvostelu"
          ></textarea>
          <button @click="addReview">Lisää arvostelu</button>
        </div>
      </div>
    </div>

    <script>
      const { createApp } = Vue;
      const API_URL = "http://localhost:3000/api";

      createApp({
        data() {
          return {
            username: "",
            currentUser: localStorage.getItem("user"),
            products: [],
            selectedProduct: null,
            showForm: false,
            newReview: "",
            newProduct: {
              name: "",
              description: "",
            },
          };
        },
        async mounted() {
          await this.fetchProducts();
        },
        methods: {
          async fetchProducts() {
            try {
              const response = await fetch(`${API_URL}/tuotteet`);
              this.products = await response.json();
            } catch (err) {
              console.error("Tuotteiden lataus epäonnistui", err);
            }
          },

          login() {
            if (!this.username) return;
            localStorage.setItem("user", this.username);
            this.currentUser = this.username;
            this.username = "";
          },

          logout() {
            localStorage.removeItem("user");
            this.currentUser = null;
          },

          async addProduct() {
            if (!this.newProduct.name || !this.newProduct.description) return;
            try {
              const response = await fetch(`${API_URL}/tuotteet`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  tuoteNimi: this.newProduct.name,
                  tuoteKuvaus: this.newProduct.description,
                }),
              });
              const created = await response.json();

              this.products.push(created);

              this.newProduct = { name: "", description: "" };
              this.showForm = false;
            } catch (err) {
              alert("Tuotteen tallennus epäonnistui");
            }
          },

          async openProduct(product) {
            const productName = product.tuoteNimi || product.name;
            this.selectedProduct = {
              ...product,
              name: productName,
              description: product.tuoteKuvaus || product.description,
            };
            this.selectedProduct.reviews = [];

            try {
              const response = await fetch(
                `${API_URL}/tuotearvostelut?tuote=${encodeURIComponent(productName)}`,
              );
              const data = await response.json();
              this.selectedProduct.reviews = data.map((r) => ({
                ...r,
                editing: false,
              }));
            } catch (err) {
              console.error("Arvostelujen lataus epäonnistui", err);
            }
          },

          async addReview() {
            if (!this.newReview) return;
            const reviewData = {
              tuote: this.selectedProduct.name,
              arvostelu: this.newReview,
              kirjoittaja: this.currentUser,
            };
            try {
              const response = await fetch(`${API_URL}/tuotearvostelut`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reviewData),
              });
              const savedReview = await response.json();
              this.selectedProduct.reviews.push({
                ...savedReview,
                editing: false,
              });
              this.newReview = "";
            } catch (err) {
              alert("Arvostelun tallennus epäonnistui");
            }
          },

          async saveEditedReview(review) {
            if (review.kirjoittaja !== this.currentUser) {
              alert("Voit muokata vain omia arvostelujasi!");
              return;
            }
            try {
              await fetch(`${API_URL}/tuotearvostelut/${review._id}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  "x-user-name": this.currentUser,
                },
                body: JSON.stringify({
                  tuote: review.tuote,
                  arvostelu: review.arvostelu,
                  kirjoittaja: review.kirjoittaja,
                }),
              });
              review.editing = false;
            } catch (err) {
              alert("Päivitys epäonnistui");
            }
          },

          async deleteReview(review) {
            if (review.kirjoittaja !== this.currentUser) {
              alert("Et voi poistaa muiden arvosteluja!");
              return;
            }
            if (!confirm("Poistetaanko arvostelu?")) return;
            try {
              await fetch(`${API_URL}/tuotearvostelut/${review._id}`, {
                method: "DELETE",
                headers: { "x-user-name": this.currentUser },
              });
              this.selectedProduct.reviews =
                this.selectedProduct.reviews.filter(
                  (r) => r._id !== review._id,
                );
            } catch (err) {
              alert("Poisto epäonnistui");
            }
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
